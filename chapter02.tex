\chapter{Tarjeta de adquisición de señales}

Para preparar el sistema de adquisición y procesado de señales se dispuso en origen de una tarjeta de adquisición con interfaz \textsc{pci}. En concreto se ha empleado el modelo \kpci{} de la casa \emph{Keithley}. A continuación se exponen las características técnicas que ofrece este dispositivo, en apartados siguientes una breve descripción funcional y la disposición y uso de los puertos presentes en el mencionado dispositivo.


\section{Características técnicas del hardware}

La tarjeta \kpci{} puede emplearse para la adquisición y conversión de señales analógicas en señales digitales, para sintetizar señales analógicas a partir de señales digitales previamente generadas o almacenadas, o ---gracias a sus 32 puertos digitales de propósito general--- trabajar con señales digitales.\par
El primer bloque del sistema electrónico de medida propuesto, es decir el sistema de adquisición y procesado de señales, tan sólo requiere de la función de adquisición analógica de la tarjeta. Por ello, de entre todas las características del dispositivo, se ha creído conveniente resumir a continuación aquellas que tienen relación directa con dicha función. Para obtener información detallada sobre la relación que estos atributos guardan con el proceso de adquisición de señales analógicas en la tarjeta \kpci{}, recúrrase a la \vref{sec:functional-description}.

\begin{itemize}
	\item El módulo de adquisición analógica dispone de 16 puertos físicos.
	\item La impedancia de entrada equivalente de cada puerto es aproximadamente igual a una capacidad de 200 pF en serie con una resistencia de valor inferior, pero aproximadamente igual, a 1 K$\Omega$.
	\item En condiciones óptimas, es posible conseguir un rendimiento máximo de 100 KS/s (cien mil operaciones de conversión por segundo). Este valor está sujeto a un error relativo del $0.02 \%$.
	\item La resolución del conversor analógico digital es de 16 bits por muestra. El rango de amplitudes en el que opera depende de como esté configurado el modo de adquisición.% Este puede ser de 0 a 10 si el modo de adquisición es unipolar, o de -10 a 10 si es bipolar.
	\item La cola de muestreo tiene capacidad para hasta 256 canales distintos. Cada uno de los cuales puede configurarse independientemente en términos de ganancia, frecuencia de muestreo, modo de adquisición o modo de terminación.
	\item La ganancia, responsable en parte de la resolución con la que se cuantifica las muestras, puede tomar cada ciclo de reloj uno de entre 16 valores posibles. Véase el cuadro \vref{tab:acquisition-modes}.
	% \item Soporte, tanto en el modo de adquisición y conversión como en el modo de síntesis, para disparo digital externo o controlado por software.
	% \item Selección por software del flanco activo de disparo.
	% \item Capacidad de interrumpir el muestreo tras un determinado número de ciclos después del disparo. La cantidad de ciclos puede controlarse por software.
\end{itemize}


\section{Descripción funcional}\label{sec:functional-description}

Es necesario programar el comportamiento de la tarjeta de adquisición antes de ponerla en funcionamiento. Desde la cola de muestreo se controlan los principales aspectos del proceso de adquisición, como por ejemplo, en que instantes se encuentra activo.\par% La configuración correspondiente al proceso de adquisición analógica reside en su práctica totalidad en la cola de muestreo. Desde la cola se controlan los principales aspectos de este proceso, como por ejemplo, en que instantes se encuentra activo.\par
La cola de muestreo, como su propio nombre indica, es una estructura de datos ordenada. Se encuentra almacenada en una memoria \textsc{ram} de 256 entradas que forma parte del hardware de la tarjeta. En el \vref{tab:sample-queue} puede verse una representación de un ejemplo de la cola de muestreo.\par

\begin{table}[h]
	\begin{center}
	\begin{threeparttable}
	\begin{tabular}{lccccccccc}
		\toprule
		Posición en la cola & 1 & 2 & 3 & 4 %
		& \multicolumn{2}{c}{$\cdots$} & 254 & 255 & 256 \\
		\midrule
		Número de canal & 15 & 15 & 02 & 02 %
		& \multicolumn{2}{c}{$\cdots$} & 17 & 13 & 01 \\
		Número de puerto\minifootnotemark{a, b} & 07 & 07 & 11 & 11 %
		& \multicolumn{2}{c}{$\cdots$} & 07 & 09 & 01 \\
		Ganancia & 1 & 1 & 40 & 40 %
		& \multicolumn{2}{c}{$\cdots$} & 200 & 8 & 80 \\
		Modo de adquisición\minifootnotemark{c} & $\pm$ & $\pm$ & $+$ & $+$ %
		& \multicolumn{2}{c}{$\cdots$} & $\pm$ & $+$ & $\pm$ \\
		Modo de terminación\minifootnotemark{d} & \textsc{d} & \textsc{d} & \textsc{ts} %
		& \textsc{ts} & \multicolumn{2}{c}{$\cdots$} & \textsc{d} & \textsc{ts} %
		& \textsc{ts} \\
		\bottomrule
	\end{tabular}
	\vspace{\skip\footins}
	\minifootnoterule
		\minifootnotetext{a}{Si el canal es diferencial el número de puerto identifica un par de puertos. Un canal diferencial no puede estar asociado a un número de puerto superior a 07.}
		\minifootnotetext{b}{Dos canales pueden estar relacionados con los mismos puertos físicos.}
		\minifootnotetext{c}{$\pm$ configuración bipolar; $+$ configuración unipolar}
		\minifootnotetext{d}{\textsc{d} canal diferencial; \textsc{ts} canal monoterminal}
	\end{threeparttable}
	\end{center}
	\caption{Ejemplo de cola de muestreo}
	\label{tab:sample-queue}
\end{table}

Cada entrada en la memoria \textsc{ram} se identifica con una posición en la cola. Las posiciones en la cola pueden encontrarse vacías o estar ocupadas por un canal. Varias posiciones en la cola, consecutivas o no, pueden estar ocupadas por un mismo canal. Por tanto, la cola puede estar ocupada, como máximo, por 256 canales independientes.\par
Las posiciones ocupadas contienen información correspondiente al canal y a los atributos asociados a este. Un canal es una entidad lógica que relaciona un puerto físico con un búffer de información y una serie de atributos. Durante el proceso de adquisición un puntero recorre las distintas posiciones de la cola, una a una y en orden. El canal activo, aquel que ocupa la posición a la que apunta el puntero en cada ciclo de reloj, determina tres cosas:

\begin{itemize}
	% \footnote{Por convenio se ha elegido hablar de una sola señal que entra al amplificador. Si se ha hecho esta elección, es porque si bien al amplificador pueden entrar una o dos señales simultáneamente desde sendos puertos, tal y como se verá más adelante, esto no supone otra diferencia para el proceso que la expuesta en la sección \vref{sec:termination-modes}
	\item De qué puerto debe proceder la señal analógica\footnote{Por convenio se ha elegido hablar de una sola señal que entra al amplificador. Si se ha hecho esta elección, es porque si bien al amplificador pueden entrar una o dos señales simultáneamente, esto no supone otra diferencia para el proceso que la expuesta en la sección \vref{sec:termination-modes}. Es por ello, y para mantener la claridad, que se ha omitido esta posibilidad.} que llega al amplificador de instrumentación interno de la tarjeta.
	\item Dónde, en qué búffer, debe almacenarse el valor resultante de muestrear y cuantificar esta señal.% las muestras cuantificadas resultantes del proceso.
	\item Por último, los atributos asociados al canal: ganancia, modo de adquisición y modo de terminación; indican, respectivamente, cuál debe ser la ganancia del amplificador de instrumentación, cuál debe ser el rango de trabajo del conversor analógico digital, y qué se debe conectar a los terminales de entrada del amplificador de instrumentación. Se da más información al respecto en apartados subsiguientes.% la polaridad de las muestras y el número de terminales de entrada, uno o dos dependiendo de si la adquisición es diferencial o no, durante el ciclo actual.
\end{itemize}

Para concluir el apartado cabe remarcar lo siguiente. Es posible inferir dos cosas de esta mecánica de funcionamiento basada en la cola. Una de ellas es que el proceso de adquisición afecta a una sola señal cada vez. Y la segunda, que la frecuencia de muestreo ligada a un canal depende de dos factores, de la velocidad de la señal de reloj, y de la cantidad de veces que un canal aparece repetido en la cola.


\subsection{Métodos de entrada}

La \kpci{} permite dos modos de adquisición y dos modos de terminación. Aprender a diferenciar cuando es oportuno seleccionar entre cada uno de ellos beneficiará la calidad de la señal digital resultante.


\subsubsection{Modos de adquisición}
Una señal es bipolar cuando toma valores positivos y negativos. Por el contrario, se distingue a las señales unipolares porque todos sus valores mantienen la misma polaridad, ya sea ésta positiva o negativa. Para cada canal, debe configurarse el modo de adquisición como bipolar o unipolar\footnote{La tarjeta \kpci{} sólo admite señales unipolares de polaridad positiva.} atendiendo a la señal de interés.\par
% El modo de adquisición unipolar presenta la ventaja de que en dicho modo prácticamente se duplica la resolución de las muestras. Manteniendo la ganancia, se reduce el rango de trabajo a la mitad. El paso correspondiente a una cuantificación de 16 bits se reduce de igual manera y, por tanto, aumenta la precisión.
Si se sabe a ciencia cierta que la señal de entrada es unipolar debe emplearse el modo de adquisición unipolar. De ese modo, se duplica la resolución del conversor analógico digital.

\begin{table}[hbt]
	\begin{center}
		\begin{tabular}{>{\raggedleft}p{1.2cm}d{5.2}d{3.1}+d{3.1}}
			\toprule
			& \multicolumn{2}{c}{Bipolar} & \multicolumn{2}{c}{Unipolar} \\
			\cmidrule(r){2-3}\cmidrule(l){4-5}
			\multicolumn{1}{c}{Ganancia}
			& \multicolumn{1}{c}{Rango ($\pm\text{V}$)} %
			& \multicolumn{1}{c}{Precisión ($\mu\text{V}$)} %
			& \multicolumn{1}{c}{Rango (V)} %
			& \multicolumn{1}{c}{Precisión ($\mu\text{V}$)} \\
			\midrule
			1 & 10,0 & 305 & 0/$10,0$ & 153 \\
			2 & 5,0 & 153 & 0/$5,0$ & 76 \\
			4 & 2,5 & 76 & 0/$2,5$ & 38 \\
			8 & 1,25 & 38 & 0/$1,25$ & 19 \\
			10 & 1,0 & 31 & 0/$1,0$ & 15 \\
			\\
			& \multicolumn{2}{c}{Bipolar} & \multicolumn{2}{c}{Unipolar} \\
			\cmidrule(r){2-3}\cmidrule(l){4-5}
			\multicolumn{1}{c}{Ganancia}
			& \multicolumn{1}{c}{Rango ($\pm\text{mV}$)} %
			& \multicolumn{1}{c}{Precisión ($\mu\text{V}$)} %
			& \multicolumn{1}{c}{Rango (mV)} %
			& \multicolumn{1}{c}{Precisión ($\mu\text{V}$)} \\
			\midrule
			20 & 500 & 15 & 0/500 & 7,6 \\
			40 & 250 & 7,6 & 0/250 & 3,8 \\
			80 & 125 & 3,8 & 0/125 & 1,9 \\
			100 & 100 & 3,1 & 0/100 & 1,5 \\
			200 & 50 & 1,5 & 0/50 & 0,8 \\
			400 & 25 & 0,8 & 0/25 & 0,4 \\
			800 & 12,5 & 0,4 & 0/$12,5$ & 0,2 \\
			\bottomrule
		\end{tabular}
		\caption{Relación entre ganancia, rango de trabajo y resolución según el modo de adquisición}
	\end{center}
	\label{tab:acquisition-modes}
\end{table}


\subsubsection{Modos de terminación}\label{sec:termination-modes}

Internamente, la tarjeta \kpci{} emplea un amplificador de instrumentación diferencial. En principio este hecho implicaría que a cada canal se asociasen dos puertos físicos, uno por cada uno de los dos terminales de entrada del amplificador. No obstante, es posible configurar la tarjeta para que uno de los terminales del amplificador se conecte a masa. En ese caso, el terminal restante se conecta a un puerto físico.\par

\begin{figure}[htp]
	\begin{center}
		\includegraphics[width=.8\linewidth]{chapter02-01.mps}
	\end{center}
	\caption{Figura que muestra el modo de terminación sencillo. La entrada superior del amplificador de instrumentación se conecta al puerto 9 y la entrada inferior se conecta a masa}
	\label{fig:termination-modes}
\end{figure}

Para hacerlo, cabría pensar que es suficiente con modificar el atributo que controla el modo de terminación del canal correspondiente. Al contrario de lo que pudiera parecer, el modo de terminación es una propiedad que no es atribuible al canal, si no que se atribuye a un par de puertos\footnote{Aunque según las especificaciones del fabricante es posible configurar cada par de puertos para que opere según un modo de terminación independiente del resto, \matlab{} sólo admite un modo de terminación para el conjunto total de puertos.}. En concreto, el modo de terminación afecta a los pares de puertos compuestos por un primero de entre los puertos 0 y 7, y un segundo cuyo número de puerto es igual al del primero más 8. De ahí que todos los canales relacionados con el mismo par de puertos deban estar configurados con el mismo modo de terminación, una configuración distinta no está permitida.\par
Los dos modos de terminación posibles se conocen como: diferencial, si es que la señal que entra en cada terminal del amplificador procede de cada uno de los puertos del par; sencillo, en caso de que uno de los terminales de entrada del amplificador se conecte a la referencia de tensión. En este documento se llama canal diferencial a los canales cuyo modo de terminación sea diferencial, y canal con un sólo terminal o monoterminal a aquellos para los que el modo de terminación es sencillo. \par
Las ventajas que presenta el uso de uno u otro tipo de canales son comprensibles. Emplear canales con un sólo terminal permite aplicar el proceso de adquisición sobre un mayor número de señales simultáneamente. Por el contrario, utilizar canales diferenciales redunda en una mayor inmunidad frente al ruido. Además, los amplificadores diferenciales eliminan de forma inherente la componente en continua.\par
\par


\subsection{Rendimiento}

Se entiende como rendimiento la cantidad máxima de operaciones de conversión que el dispositivo puede realizar por unidad de tiempo. Para que una de estas operaciones contribuya a la medida de rendimiento debe superar un requisito de precisión.\par
El rendimiento óptimo de la tarjeta \kpci{} especificado por el fabricante es de cien mil operaciones por segundo (100 KS/s). No obstante se advierte, para obtener este nivel de rendimiento es necesario alimentar la tarjeta con una fuente de tensión ideal. Además, es importante que exista adaptación de impedancias entre el circuito de alimentación y el puerto por el que se quiere introducir la señal. Aún en estas condiciones el valor proporcionado por la casa Keithley está sujeto a un error relativo máximo del $0.02\%$, el cual supone un error absoluto máximo de dos mil operaciones por segundo (2 KS/s).


\subsubsection{Optimización del rendimiento}

El amplificador de instrumentación interno de la \kpci{} es de ganancia variable. Es posible configurar una ganancia distinta para cada canal. El propósito de que esto sea así es conseguir que la amplitud de la señal que entra al conversor analógico digital se encuentre en su rango de trabajo ---de -10 a 10 voltios en configuración bipolar y de 0 a 10 voltios en configuración unipolar--- con independencia de la amplitud de las señales que entran a la tarjeta. De esta forma la \kpci{} es capaz de trabajar simultáneamente con varias señales de amplitud diferente conservando gran parte de la información que éstas transportan.\par
La desventaja que presenta esta configuración es una ocasional pérdida de rendimiento a causa de la intervención del amplificador en la operación de adquisición. Las razones se detallan a continuación.\par
La desventaja que presenta esta configuración es una pérdida de rendimiento a causa de la intervención del amplificador en la operación de adquisición que se produce en situaciones determinadas. Las razones se detallan a continuación.\par
Cada ciclo de reloj cambia el canal activo y debe cambiar, si es oportuno, la señal que accede al amplificador. Este proceso no es inmediato. Primero conmuta el multiplexor que precede al amplificador dando paso al puerto conveniente. Sin embargo, la señal que recibe el amplificador presenta, hasta transcurrido un determinado periodo de tiempo, una componente residual de la señal que se amplificó en el anterior ciclo de reloj. Transcurrido dicho periodo de tiempo la señal que entra al amplificador se ve libre de esa componente residual y se corresponde únicamente con la señal que entrega el multiplexor, se dice que se ha fijado la señal.
Las componentes residuales están presentes al menos en el primer ciclo de reloj en el que una nueva señal accede al amplificador. Dichas componentes alteran
Es necesario fijar la señal para preservar el nivel de precisión, más aún sabiendo que fijando la señal se evita saturar el conversor de forma indeseada.

La desventaja que presenta esta configuración es una pérdida de rendimiento que se produce en situaciones determinadas a causa de la intervención del amplificador en la operación de adquisición. Cada ciclo de reloj cambia el canal activo y debe cambiar, si es oportuno, la señal que accede al amplificador. Este proceso no es inmediato. Primero conmuta el multiplexor que precede al amplificador dando paso al puerto conveniente. Sin embargo, la señal que recibe el amplificador presenta, hasta transcurrido un determinado periodo de tiempo, una componente residual de la señal que se amplificó en el anterior ciclo de reloj. Transcurrido dicho periodo de tiempo la señal que entra al amplificador se ve libre de esa componente residual y se corresponde únicamente con la señal que entrega el multiplexor, se dice que se ha fijado la señal.
Este proceso no es inmediato, tras conmutar el multiplexor que precede al amplificador, se da paso al puerto conveniente. No obstante, la señal que recibe el amplificador presenta, hasta transcurrido un determinado periodo de tiempo, una componente residual de la señal que se amplificó en el anterior ciclo de reloj. Transcurrido dicho periodo de tiempo la señal que entra al amplificador se ve libre de esa componente residual y se corresponde únicamente con la señal que entrega el multiplexor, se dice que se ha fijado la señal.
Y después se fija el valor de la señal a la entrada del amplificador.

Al contrario de lo que pudiera parecer, la señal que percibe el amplificador a su entrada es continua y no presenta transiciones bruscas en los cambios de ciclo. Cuando la señal que entrega el multiplexor cambia se produce en la señal que recibe el amplificador una transición suave entre la señal indicada por el canal activo en el ciclo anterior y la denotada por el canal activo en el ciclo vigente.



La desventaja que presenta esta configuración es una pérdida de rendimiento a causa de la intervención del amplificador en la operación de adquisición. El motivo no es otro que el retardo existente entre el instante en el que el multiplexor que precede al amplificador conmuta entre un par de puertos y el momento en el que éste empieza a observar la señal correcta a su entrada. Durante ese periodo de tiempo  % es que la intervención del amplificador en la operación de adquisición se traduce en una pérdida de rendimiento | en la mayoría de los casos | motivo de
La desventaja que presenta esta configuración es una pérdida de rendimiento a causa de la intervención del amplificador en la operación de adquisición. Las dos situaciones en las que se observa una pérdida de rendimiento son las siguientes:
 - Se produce una pérdida de rendimiento, el cual se reduce prácticamente a la mitad, cuando la amplitud de la señal de entrada a la tarjeta tiene el límite superior en 100 mV.
 - En configuraciones multiganancia en las que se encadenan secuencias de canales con diferente ganancia en la cola de muestreo.
El comportamiento del amplificador explica estas situaciones. En primer lugar se debe aclarar que la señal que el amplificador percibe a su entrada es continua y los cambios que en ella se producen no son abruptos si no graduales. Esto quiere decir que la transición entre dos señales diferentes no es inmediata si no que requiere cierto tiempo. Durante ese periodo de tiempo el amplificador observará a su entrada la señal correcta corrompida por una componente residual de la señal precedente.
 - El amplificador <<observa>> una señal continua a su entrada. Otra forma de decir lo mismo es decir que componentes residuales de la señal amplificada permanecen a la entrada del amplificador incluso ante la llegada de una nueva señal.
 - Las consecuencias de las componentes van desde la alteración de los resultados de la conversión por contaminación de la señal de interés hasta truncamientos en el resultado provocados por la saturación del conversor.
 - Una vez que la señal de entrada del amplificador sigue a la señal que realmente debe amplificar se dice que se ha fijado la señal a su entrada.
 - Pérdida de rendimiento, que se reduce prácticamente a la mitad, cuando la amplitud de la señal de entrada tiene el límite superior en 100 mV.
 - Posiblemente esta pérdida de rendimiento se deba a la lentitud con la que se fijan las señales de pequeña amplitud. La necesidad de una cantidad de tiempo mayor para fijar señales con valores de tensión de pico iguales o inferiores a 100 mV quizá esté relacionada con el hecho de que estas señales se ven afectadas en mayor medida por el ruido. Una razón para esto es que la magnitud de ruido y señal es comparable.
 - Esto crea una situación de incertidumbre que termina por perjudicar la precisión del proceso y esto afecta en última instancia al rendimiento. Las consecuencias son aún más notorias cuando la configuración es multiganancia y la señal precedente de una amplitud de pico mucho mayor debido a componentes residuales de la señal que permanecen a la entrada del amplificador.
 - Pérdida de rendimiento en configuraciones multiganancia en las que se encadenan secuencias de canales con diferente ganancia en la cola de muestreo.
 - Una solución trivial a estos problemas pasa por preamplificar las señales que llegan a la tarjeta para que se encuentren en el mismo rango de amplitudes.
 - Supongamos la siguiente situación, al amplificador entra una señal cuyo nivel de tensión es fácil de seguir principalmente a causa de que este supera los 100 mV y no existe incertidumbre debida al ruido. En el siguiente ciclo de reloj el puerto de entrada cambia, la tensión de la señal que el amplificador <<ve>> a su entrada cae con lentitud hasta alcanzar valores muy pequeños similares a los que presenta la señal que debe amplificarse. No obstante, la falta de certeza trae como consecuencia el acometimiento de errores.
